<!DOCTYPE html>
<html lang="en-US">
    <head>
        <meta charset="utf-8"> 
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="author" content="Rongfei" />
        <meta name="copyright" content="Rongfei" />

        <meta property="og:type" content="article" />
        <meta name="twitter:card" content="summary">

<meta name="keywords" content=", ops, " />

<meta property="og:title" content="ansible learn "/>
<meta property="og:url" content="/drafts/ansible-learn.html" />
<meta property="og:description" content="Category: ops Tags: ops,ansible,自动化运维 Authors: Chrysan Status: published ansible learn 1.简介 Ansible 是用python开发的一款服务器批量管理工具。基于ssh通信简单易用,无需客户端。 2.安装 Ansible 能够安装到 Linux、BSD、Mac OS X 等平台，Python 版本最低要求为 2.6。ansible是python编写可以使用python包管理器安装. $ sudo pip install ansible 3.使用 使用ansible有两种方式 ..." />
<meta property="og:site_name" content="LearnDevOps" />
<meta property="og:article:author" content="Rongfei" />
<meta property="og:article:published_time" content="2015-12-04T10:57:00+08:00" />
<meta name="twitter:title" content="ansible learn ">
<meta name="twitter:description" content="Category: ops Tags: ops,ansible,自动化运维 Authors: Chrysan Status: published ansible learn 1.简介 Ansible 是用python开发的一款服务器批量管理工具。基于ssh通信简单易用,无需客户端。 2.安装 Ansible 能够安装到 Linux、BSD、Mac OS X 等平台，Python 版本最低要求为 2.6。ansible是python编写可以使用python包管理器安装. $ sudo pip install ansible 3.使用 使用ansible有两种方式 ...">

        <title>ansible learn  · LearnDevOps
</title>
        <link href="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/css/bootstrap-combined.min.css" rel="stylesheet">
        <link href="//netdna.bootstrapcdn.com/font-awesome/4.0.1/css/font-awesome.css" rel="stylesheet">
        <link rel="stylesheet" type="text/css" href="/theme/css/pygments.css" media="screen">
        <link rel="stylesheet" type="text/css" href="/theme/tipuesearch/tipuesearch.css" media="screen">
        <link rel="stylesheet" type="text/css" href="/theme/css/elegant.css" media="screen">
        <link rel="stylesheet" type="text/css" href="/theme/css/custom.css" media="screen">
    </head>
    <body>
        <div id="content-sans-footer">
        <div class="navbar navbar-static-top">
            <div class="navbar-inner">
                <div class="container-fluid">
                    <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </a>
                    <a class="brand" href="/"><span class=site-name>LearnDevOps</span></a>
                    <div class="nav-collapse collapse">
                        <ul class="nav pull-right top-menu">
                            <li ><a href="">Home</a></li>
                            <li ><a href="/pages/about-me.html">About Me</a></li>
                            <li ><a href="/categories.html">Categories</a></li>
                            <li ><a href="/tags.html">Tags</a></li>
                            <li ><a href="/archives.html">Archives</a></li>
                            <li><form class="navbar-search" action="/search.html" onsubmit="return validateForm(this.elements['q'].value);"> <input type="text" class="search-query" placeholder="Search" name="q" id="tipue_search_input"></form></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        <div class="container-fluid">
            <div class="row-fluid">
                <div class="span1"></div>
                <div class="span10">
<article>
<div class="row-fluid">
    <header class="page-header span10 offset2">
    <h1><a href="/drafts/ansible-learn.html"> ansible learn  </a></h1>
    </header>
</div>

<div class="row-fluid">
        <div class="span8 offset2 article-content">

            
            <!--
Modified: 2015-12-07 16:21 
Slug: ansible learn
Summary: ansible 学习使用笔记
-->

<p>Category: ops
Tags: ops,ansible,自动化运维
Authors: Chrysan
Status: published</p>
<h1 id="ansible-learn">ansible learn</h1>
<h2 id="1">1.简介</h2>
<p>Ansible 是用python开发的一款服务器批量管理工具。基于ssh通信简单易用,无需客户端。</p>
<h2 id="2">2.安装</h2>
<p>Ansible 能够安装到 Linux、BSD、Mac OS X 等平台，Python 版本最低要求为 2.6。ansible是python编写可以使用python包管理器安装.</p>
<div class="codehilite" style="background: #f8f8f8"><pre style="line-height: 125%">    $ sudo pip install ansible
</pre></div>


<h2 id="3">3.使用</h2>
<p>使用ansible有两种方式:Ad-hoc command 和 playbook。前者用于临时类批量操作，后者用于配置管理，类似与Puppet。</p>
<h3 id="31">3.1 前提</h3>
<p>在使用ansible之前需要做好ssh信任和sudo权限密码取消</p>
<h4 id="311-ssh">3.1.1 做好ssh单向信任</h4>
<h4 id="312-ssh-agent">3.1.2 ssh-agent环境</h4>
<h4 id="313-sudo">3.1.3 sudo权限取消密码认证</h4>
<h3 id="32-inventory">3.2 inventory配置</h3>
<p>ah-hoc 和 playbook都是基于 hosts文件来操作。inventory 其实就是hosts 主机的的分组文件,官方文档中说默认在:/etc/ansible/hosts 我自己安装完后并不存在这个文件，可以自己创建。也可以指定任何位置。</p>
<h4 id="321">3.2.1 主机与组</h4>
<p>默认hosts文件配置  <br />
主机可以用ip，域名，别名等，一个主机可以属于多个组。可以指定要登陆的端口号，用户名，密码(不推荐直接明文指定密码) 建议使用:?(后面再添加)</p>
<p>普通主机组</p>
<div class="codehilite" style="background: #f8f8f8"><pre style="line-height: 125%">$ cat /etc/ansible/hosts
    mail.example.com  <span style="color: #008800; font-style: italic">#主机名 </span>

    <span style="color: #666666">[</span>webservers<span style="color: #666666">]</span>      <span style="color: #008800; font-style: italic">#组名</span>
    foo.example.com
    bar.example.com

    <span style="color: #666666">[</span>dbservers<span style="color: #666666">]</span>
    one.example.com
    two.example.com
    three.example.com
</pre></div>


<p>指定端口</p>
<div class="codehilite" style="background: #f8f8f8"><pre style="line-height: 125%">    $ cat /etc/ansible/hosts
        www.example.com:端口号  <span style="color: #008800; font-style: italic">#端口号</span>
</pre></div>


<p>指定登陆用户名和连接方式</p>
<div class="codehilite" style="background: #f8f8f8"><pre style="line-height: 125%">    $ cat /etc/ansible/hosts
        <span style="color: #666666">[</span>targets<span style="color: #666666">]</span>
        localhost              <span style="color: #B8860B">ansible_connection</span><span style="color: #666666">=</span><span style="color: #AA22FF">local</span>
        other1.example.com     <span style="color: #B8860B">ansible_connection</span><span style="color: #666666">=</span>ssh        <span style="color: #B8860B">ansible_ssh_user</span><span style="color: #666666">=</span>mpdehaan
        other2.example.com     <span style="color: #B8860B">ansible_connection</span><span style="color: #666666">=</span>ssh        <span style="color: #B8860B">ansible_ssh_user</span><span style="color: #666666">=</span>mdehaan
</pre></div>


<h4 id="322">3.2.2 主机变量</h4>
<p>ansible_ssh_host，连接目标主机的地址。
ansible_ssh_port，连接目标主机SSH端口，端口22无需指定。
ansible_ssh_user，连接目标主机默认用户。
ansible_ssh_pass，连接目标主机默认用户密码。 
ansible_connection，目标主机连接类型，可以是local、ssh或paramiko。
ansible_ssh_private_key_file, 连接目标主机的ssh私钥。
ansible_*_interpreter，指定采用非Python的其他脚本语言，如Ruby、Perl或其他类似ansible_python_interpreter解释器。</p>
<h3 id="33-api">3.3 模块及API</h3>
<div class="codehilite" style="background: #f8f8f8"><pre style="line-height: 125%">    $ ansible-doc -l   <span style="color: #008800; font-style: italic">#查看所有的模块</span>
    $ ansible-doc -s  module_name  <span style="color: #008800; font-style: italic">#模块的具体使用方法</span>
</pre></div>


<p>Ansible提供了非常丰富的功能模块，包括:</p>
<div class="codehilite" style="background: #f8f8f8"><pre style="line-height: 125%">Cloud（云计算）
Commands（命令行）
Database（数据库）
Files（文件管理）
Inter-nal（内置功能）
Inventory（资产管理）
Mes-saging（消息队列）
Monitoring（监控管理）
Net Infrastructure（网络基础服务）
Network（网络管理）
Notification（通知管理）
Packaging（包管理）
Source Control（版本控制）
System（系统服务）
Utilities（公共服务）
Web Infrastruc-ture（Web基础服务）等等，
</pre></div>


<p>更多模块介绍见<a href="http://ansibleworks.com/docs/modules.html">官网模块介绍</a>
模块默认存储目录为/usr/share/ansible/，系统不同安装方式不同会导致路径不一致。我的MAC使用brew 安装模块位置在/usr/local/Cellar/ansible/1.9.4/libexec/lib/python2.7/site-packages/ansible/modules
存储结构以模块分类名作为目录名，模块文件按分类存放在不同类别目录中。</p>
<h3 id="34">3.4 完成任务</h3>
<p>Ansible提供两种方式去完成任务,一是 ad-hoc 命令,一是写 Ansible playbook.前者可以解决一些简单的任务, 后者解决较复杂的任务.
简单来说ad-hoc 和 playbook 类似于在命令行敲入shell命令和 写shell scripts一样。</p>
<h4 id="341-ad-hoc-commands">3.4.1 Ad-Hoc Commands</h4>
<p>ad-hoc 的使用场景通常一些比较临、单一的不需要经常重复操作的动作,不需要将这些执行的命令保存下来的我们就使用使用ad-hoc，
Ad-hoc命令的格式一般如下：</p>
<div class="codehilite" style="background: #f8f8f8"><pre style="line-height: 125%">    $ ansible groupname -i inventory -m module -a arguments
</pre></div>


<p>其中默认的模块名为command，即“-m command”可省略。获取远程webservers组主机的uptime</p>
<h4 id="342-ad-hoc">3.4.2 ad-hoc 例子</h4>
<p>展示一个查看 test主机运行时间的例子:</p>
<div class="codehilite" style="background: #f8f8f8"><pre style="line-height: 125%">inventory 文件：
</pre></div>


<div class="codehilite" style="background: #f8f8f8"><pre style="line-height: 125%">    $ cat /etc/ansible/host
       test1w.cn
       test0w
</pre></div>


<div class="codehilite" style="background: #f8f8f8"><pre style="line-height: 125%">执行命令:
</pre></div>


<div class="codehilite" style="background: #f8f8f8"><pre style="line-height: 125%">    $ ansible all -i host -m <span style="color: #AA22FF">command</span> -a <span style="color: #BB4444">&quot;uptime&quot;</span>
      test1w.cn | success | <span style="color: #B8860B">rc</span><span style="color: #666666">=0</span> &gt;&gt;
      14:57:45 up <span style="color: #666666">88</span> days,  1:19,  <span style="color: #666666">1</span> user,  load average: 0.00, 0.00, 0.00

      test0w | success | <span style="color: #B8860B">rc</span><span style="color: #666666">=0</span> &gt;&gt;
      14:55:31 up <span style="color: #666666">59</span> days, 22:41,  <span style="color: #666666">1</span> user,  load average: 0.00, 0.00, 0.00
</pre></div>


<h4 id="343-api">3.4.3 查看模块及api的帮助</h4>
<p>命令格式:</p>
<div class="codehilite" style="background: #f8f8f8"><pre style="line-height: 125%">    $ ansible-doc 模块名
</pre></div>


<p>command 模块的帮助：</p>
<div class="codehilite" style="background: #f8f8f8"><pre style="line-height: 125%">    $ ansible-doc <span style="color: #AA22FF">command</span>
    &gt; COMMAND

          The <span style="color: #666666">[</span>command<span style="color: #666666">]</span> module takes the <span style="color: #AA22FF">command</span> name followed by a list of
          space-delimited arguments. The given <span style="color: #AA22FF">command</span> will be executed on all
          selected nodes. It will not be processed through the shell, so
          variables like <span style="color: #BB4444">`</span>$HOME<span style="color: #BB4444">&#39; and operations like `&quot;&lt;&quot;&#39;</span>, <span style="color: #BB4444">`&quot;&gt;&quot;&#39;, `&quot;|&quot;&#39;</span>, and
          <span style="color: #BB4444">`&quot;&amp;&quot;</span><span style="border: 1px solid #FF0000">&#39;</span> will not work <span style="color: #666666">(</span>use the <span style="color: #666666">[</span>shell<span style="color: #666666">]</span> module <span style="color: #AA22FF; font-weight: bold">if</span> you need these
          features<span style="color: #666666">)</span>.

          Options <span style="color: #666666">(=</span> is mandatory<span style="color: #666666">)</span>:

          - chdir
                <span style="color: #AA22FF">cd</span> into this directory before running the <span style="color: #AA22FF">command</span> <span style="color: #666666">[</span>Default:
                None<span style="color: #666666">]</span>

          - creates
                a filename, when it already exists, this step will *not* be
                run. <span style="color: #666666">[</span>Default: None<span style="color: #666666">]</span> 

          ......
</pre></div>


<h4 id="344">3.4.4 常用模块</h4>
<p>ansible 执行远程命令主要有3个模块:command、script、shell</p>
<div class="codehilite" style="background: #f8f8f8"><pre style="line-height: 125%">command: 为ansible默认模块，可以远程执行所有的shell命令。

script: 可以向远程端执行master端存储的shell脚本，相当于scp＋shell组合，

shell:  执行保存在远端的shell脚本 支持管道

raw

setup: 收集远程主机信息  没有任何参数

ping:  检查主机存活  没有任何参数

file: 对目录文件的操作

copy: 向远程主机copy文件
</pre></div>


<h4 id="345-playbook">3.4.5 playbook</h4>
<p>playbook 是由<a href="http://www.178linux.com/doc/ansible/docs/YAMLSyntax.html">yaml</a> 语言来定义的 xxx.yml 以yml为后缀的文件。 可以由文件，目录等层级来组织，通过includer多层次调用。可以直接执行任意一个文件。</p>
<h5 id="ansibleyaml">ansible中基本的YAML</h5>
<p>yml中主要标识:开头，列表，字典</p>
<div class="codehilite" style="background: #f8f8f8"><pre style="line-height: 125%">    --- #yml文档以开头以&quot;---&quot;开始

    - a #列表以&quot;- &quot;英文横线加一个空格开始
    - b
    - c 

    name: Peter #字典以简单的&quot;键: 值&quot;冒号后面是空格
    job: OP
</pre></div>


<p>官方文档中提供的一个简单的例子:</p>
<div class="codehilite" style="background: #f8f8f8"><pre style="line-height: 125%">---
- hosts: webservers
  vars:
    http_port: 80
    max_clients: 200
  remote_user: root
  tasks:
  - name: ensure apache is at the latest version
    yum: pkg=httpd state=latest
  - name: write the apache config file
    template: src=/srv/httpd.j2 dest=/etc/httpd.conf
    notify:
    - restart apache
  - name: ensure apache is running
    service: name=httpd state=started
  handlers:
    - name: restart apache
      service: name=httpd state=restarted
</pre></div>


<h2 id="_1">模块</h2>
<h2 id="_2">参考</h2>
<p><a href="http://www.178linux.com/doc/ansible/docs/intro_inventory.html#inventory">178linux.com</a></p>
            
            
            <hr/>
        </div>
        <section>
        <div class="span2" style="float:right;font-size:0.9em;">
            <h4>Published</h4>
            <time pubdate="pubdate" datetime="2015-12-04T10:57:00+08:00">12 4, 2015</time>
            <h4>Category</h4>
            <a class="category-link" href="/categories.html#ops-ref">ops</a>
        </div>
        </section>
</div>

<!-- 多说评论框 start -->
<div class="ds-thread" data-thread-key="ansible learn" data-title="ansible learn" data-url="http://blog.pyshell.cn/drafts/ansible-learn.html"></div>
<!-- 多说评论框 end -->
<!-- 多说公共JS代码 start (一个网页只需插入一次) -->
<script type="text/javascript">
var duoshuoQuery = {short_name:"devops"};
	(function() {
		var ds = document.createElement('script');
		ds.type = 'text/javascript';ds.async = true;
		ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
		ds.charset = 'UTF-8';
		(document.getElementsByTagName('head')[0] 
		 || document.getElementsByTagName('body')[0]).appendChild(ds);
	})();
	</script>
<!-- 多说公共JS代码 end -->
<!-- baidu tongji   -->
<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?b6fb6111b823b418109202b642b4a62b";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>

<!-- baidu tongji  end -->

</article>
                </div>
                <div class="span1"></div>
            </div>
        </div>
        <div id="push"></div>
    </div>
<footer>
<div id="footer">
    <ul class="footer-content">
        <li class="elegant-power">Powered by <a href="http://getpelican.com/" title="Pelican Home Page">Pelican</a>. Theme: <a href="http://oncrashreboot.com/pelican-elegant" title="Theme Elegant Home Page">Elegant</a> by <a href="http://oncrashreboot.com" title="Talha Mansoor Home Page">Talha Mansoor</a></li>
    </ul>
</div>
</footer>            <script src="http://code.jquery.com/jquery.min.js"></script>
        <script src="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/js/bootstrap.min.js"></script>
        <script>
            function validateForm(query)
            {
                return (query.length > 0);
            }
        </script>

    
    </body>
    <!-- Theme: Elegant built for Pelican
    License : http://oncrashreboot.com/pelican-elegant -->
</html>